# SpecKit 规格说明书: 图像优化器 (Curtail 复刻版)

> **版本**: v1.1.0
> **提示词类型**: Image Optimizer Implementation
> **适用场景**: 本地图像压缩与优化
> **预期效果**: 具备GUI和CLI的高性能Curtail复刻版
> **语言要求**: 中文 (Chinese)

## 🎯 第一阶段：Constitution (宪法阶段)

### 项目边界宪法
```markdown
# Image Optimizer Constitution

## 核心原则
1. **功能复刻**: 必须完美复刻Curtail的核心功能（压缩、缩放、格式转换）。
2. **用户体验**: GUI必须响应迅速，不卡死，并提供精确的进度反馈。
3. **数据安全**: 默认采用非破坏性操作（保存到新目录），除非用户明确勾选“覆盖源文件”。
4. **高性能**: 利用多线程并发处理，充分利用多核CPU。

## 技术约束
- **开发语言**: Python 3.8+
- **GUI框架**: Tkinter (Python标准库)
- **核心依赖**: Pillow (图像处理), tqdm (CLI进度条)
- **外部工具**: 优先调用 `jpegoptim`, `pngquant` 进行无损/有损压缩，若未安装则自动回退到Pillow内部优化。

## 明确不做的事
- ❌ 不实现复杂的图像编辑功能（如裁剪、滤镜、旋转）。
- ❌ 不强制用户安装外部二进制工具（必须有Fallback机制）。
- ❌ 不在主线程进行耗时操作（避免GUI假死）。
```

## 📝 第二阶段：Specification (规范阶段)

### 功能需求清单 (FR-XXX)

#### FR-001: 智能图像压缩
- **描述**: 对JPG, PNG, WebP格式进行智能压缩。
- **详细逻辑**:
    1. 检测系统中是否存在 `jpegoptim` (针对JPG) 和 `pngquant` (针对PNG)。
    2. 若存在，使用外部工具进行压缩（保留元数据的选项由用户决定，默认去除）。
    3. 若不存在，或目标格式为WebP，或进行格式转换/缩放时，使用 Pillow 的 `optimize=True` 和 `quality` 参数保存。
- **验收标准**:
    - 文件体积显著减小。
    - 视觉质量在设定范围内（默认Quality=85）。
    - 缺少外部工具时不报错，平滑降级。

#### FR-002: 智能图像缩放
- **描述**: 将图像限制在指定的最大尺寸内。
- **详细逻辑**:
    1. 获取原始图像尺寸 (W, H)。
    2. 若 max(W, H) > Max_Size，计算缩放比例 Ratio = Max_Size / max(W, H)。
    3. 新尺寸 = (W * Ratio, H * Ratio)。
    4. 使用 `Image.Resampling.LANCZOS` 算法进行高质量缩放。
- **验收标准**:
    - 处理后的图像长边不超过 Max_Size。
    - 图像长宽比保持不变。
    - 小于 Max_Size 的图像保持原样（不放大）。

#### FR-003: 多格式转换
- **描述**: 支持 JPG, PNG, WebP 之间的相互转换。
- **详细逻辑**:
    1. 用户选择目标格式（或“保持原格式”）。
    2. 若目标格式为 JPG 且源图有透明通道（RGBA），自动填充白色背景或丢弃透明度（转换为RGB）。
    3. 修改输出文件后缀名。
- **验收标准**:
    - 输出文件格式正确。
    - 透明PNG转JPG时无报错（背景处理正确）。

#### FR-004: 图形用户界面 (GUI)
- **描述**: 基于 Tkinter 的可视化操作界面。
- **界面元素**:
    - **文件区**: “添加文件”、“添加文件夹”按钮，显示选中文件数量。
    - **设置区**:
        - 质量滑块/输入框 (1-100)。
        - 线程数选择 (1-32)。
        - 最大尺寸输入框 (像素)。
        - 目标格式下拉框 (Original, JPG, PNG, WebP)。
        - “覆盖源文件”复选框。
        - “选择输出目录”按钮（覆盖未勾选时可用）。
    - **进度区**: 进度条 (0-100%)，状态标签（“正在处理 5/10...”）。
    - **日志区**: 滚动文本框，实时显示处理结果（成功/失败）。
- **验收标准**:
    - 布局整齐，无重叠。
    - 窗口大小可调整。
    - 操作流畅，处理时界面不卡顿。

#### FR-005: 高并发处理
- **描述**: 使用多线程加速批量处理。
- **详细逻辑**:
    1. 使用 `concurrent.futures.ThreadPoolExecutor`。
    2. 线程数默认为 4，用户可调。
    3. 使用 `queue.Queue` 将子线程的进度和日志传回主线程（GUI线程）。
    4. 主线程通过 `after()` 轮询队列更新UI。
- **验收标准**:
    - 处理速度随线程数增加而提升（在IO/CPU允许范围内）。
    - 进度条更新平滑。
    - 随时可查看已完成的任务日志。

#### FR-006: 配置持久化 (高可用)
- **描述**: 程序启动时自动恢复上次关闭时的设置。
- **详细逻辑**:
    1. 程序关闭时，将当前设置（Quality, Workers, MaxSize, Format, OutputDir）保存到 `config.json`。
    2. 程序启动时，读取 `config.json` 并应用到 UI 控件。
- **验收标准**:
    - 重启程序后，配置项保持不变。
    - 配置文件损坏时自动恢复默认值。

#### FR-007: 任务控制
- **描述**: 用户可以随时取消正在进行的批量处理任务。
- **详细逻辑**:
    1. 添加“停止”按钮（处理时启用，空闲时禁用）。
    2. 点击后，设置 `stop_flag`，不再提交新任务。
    3. 正在执行的任务允许完成，剩余任务标记为“已取消”。
- **验收标准**:
    - 点击停止后，进度条停止更新，日志显示“已取消”。

#### FR-008: 错误隔离与反馈
- **描述**: 增强程序的健壮性，确保单个文件错误不会导致崩溃。
- **详细逻辑**:
    1. `process_file` 内部捕获所有异常。
    2. GUI 区分显示“成功”（黑色/绿色）和“失败”（红色）日志。
    3. 进度条即使在失败时也应前进。
- **验收标准**:
    - 处理坏文件时程序不闪退。
    - 错误信息清晰可见。

#### FR-009: 智能并发控制
- **描述**: 防止因并发过高导致系统卡死。
- **详细逻辑**:
    1. 启动时检测系统 CPU 核心数 (N)。
    2. 默认线程数设为 N (或 N-1 以保留 UI 响应)。
    3. GUI 限制最大线程数为 2*N 或 32 (取小者)。
    4. 提供“低负载模式”复选框，勾选后限制为 1-2 线程。
- **验收标准**:
    - 在低配机器上启动时，默认线程数合理。
    - 用户无法设置过高的线程数。

#### FR-010: SVG 格式支持
- **描述**: 支持 SVG 矢量图压缩。
- **详细逻辑**:
    1. 检测 `svgo` 或 `scour`。
    2. 如果存在，对 .svg 文件调用优化命令。
- **验收标准**: SVG 文件体积减小。

#### FR-011: 压缩模式 (Lossy/Lossless)
- **描述**: 提供一键切换有损/无损模式。
- **详细逻辑**:
    1. Lossy: 默认 Quality=85, Strip Metadata。
    2. Lossless: Quality=100 (或工具特定参数), Keep Metadata (可选)。
- **验收标准**: 切换模式自动调整 Quality 滑块。

#### FR-012: 元数据保留控制
- **描述**: 允许用户选择是否保留 EXIF 等元数据。
- **详细逻辑**:
    1. Checkbox "Keep Metadata"。
    2. 传递给外部工具 (`--strip-none` vs `--strip-all`) 或 PIL (`exif=img.info['exif']`)。
- **验收标准**: 勾选后，输出文件包含元数据。

#### FR-013: 统计摘要
- **描述**: 处理结束后显示节省空间统计。
- **详细逻辑**:
    1. 累计所有文件的原大小和新大小。
    2. 计算 Total Saved 和 Percentage。
    3. 弹窗或 Label 显示。
- **验收标准**: 准确显示节省字节数。

## 🏗️ 第三阶段：Plan (计划阶段)

### 架构设计
```python
# 核心逻辑与UI分离
class ImageOptimizer:
    """负责具体的图像处理逻辑，不含任何GUI代码"""
    def process_file(self, file_path: Path) -> str: ...

class OptimizerApp(tk.Tk):
    """负责界面展示和线程调度"""
    def start_processing(self): ...
    def update_ui_from_queue(self): ...
```

### 实施策略
1.  **核心优先**: 先完善 `ImageOptimizer` 类，确保单元测试通过。
2.  **CLI适配**: 确保命令行工具可用，方便脚本调用。
3.  **GUI封装**: 最后开发 Tkinter 界面，调用核心类。
4.  **文档对齐**: 确保代码注释中包含 `@spec: FR-XXX` 标记。

## 📋 第四阶段：Tasks (任务阶段)

### 开发任务
- [x] T-001: 实现 `ImageOptimizer` 类（含缩放、转换、压缩）。
- [x] T-002: 实现 CLI 参数解析 (`argparse`)。
- [x] T-003: 实现 `OptimizerApp` GUI 界面布局。
- [x] T-004: 实现多线程队列通信机制。
- [ ] T-005: (文档) 将规范同步至 `AGENTS.md` 等配置文件。
